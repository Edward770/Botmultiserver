import tkinter as tk
from tkinter import filedialog, messagebox
import threading
import time

class ChatBotApp:
    def __init__(self, master):
        self.master = master
        master.title("SAFE OFFLINE CHAT BOT - MULTI-SESSION VERSION")

        self.widgets = {}

        # Fields
        fields = [
            ("Enter Passkey", "passkey"),
            ("Thread ID", "thread_id"),
            ("Opponent Name", "opponent"),
            ("Interval (seconds)", "interval")
        ]

        for label_text, key in fields:
            tk.Label(master, text=label_text).pack()
            entry = tk.Entry(master, width=50)
            entry.pack()
            self.widgets[key] = entry

        # File selectors
        self.cookies_path = ""
        self.messages_path = ""

        tk.Button(master, text="Select Cookies File", command=self.select_cookies).pack()
        tk.Button(master, text="Select Messages File", command=self.select_messages).pack()

        # Buttons
        tk.Button(master, text="START SESSION", bg='blue', fg='white', command=self.start_session).pack(pady=10)
        tk.Button(master, text="STOP SESSION", bg='red', fg='white', command=self.stop_sessions).pack()

        # Session tracking
        self.active_threads = []

    def select_cookies(self):
        self.cookies_path = filedialog.askopenfilename(title="Select Cookies File")

    def select_messages(self):
        self.messages_path = filedialog.askopenfilename(title="Select Messages File")

    def chat_worker(self, opponent, interval, messages):
        for msg in messages:
            print(f"Sending to {opponent}: {msg.strip()}")
            time.sleep(interval)

    def start_session(self):
        try:
            passkey = self.widgets['passkey'].get()
            thread_id = self.widgets['thread_id'].get()
            opponent = self.widgets['opponent'].get()
            interval = float(self.widgets['interval'].get())

            if not all([passkey, thread_id, opponent, interval, self.messages_path]):
                raise ValueError("All fields and files must be set!")

            with open(self.messages_path, 'r') as f:
                messages = f.readlines()

            t = threading.Thread(target=self.chat_worker, args=(opponent, interval, messages))
            t.start()
            self.active_threads.append(t)
            messagebox.showinfo("Started", "Chat session started!")

        except Exception as e:
            messagebox.showerror("Error", str(e))

    def stop_sessions(self):
        messagebox.showinfo("Stop", "Stopping all sessions (simulated).")
        self.active_threads.clear()


if __name__ == "__main__":
    root = tk.Tk()
    app = ChatBotApp(root)
    root.mainloop()
